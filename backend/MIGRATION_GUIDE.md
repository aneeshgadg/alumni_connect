# Database Migration Guide

This guide explains how to set up and run database migrations using Alembic.

## Initial Setup

1. **Ensure your database is running and accessible**
   - Check your `.env` file has the correct `DATABASE_URL`
   - For Supabase: Get the connection string from your Supabase dashboard

2. **Create the initial migration**:
   ```bash
   cd backend
   alembic revision --autogenerate -m "Initial migration: create users, students, alumni tables"
   ```

3. **Review the migration file**:
   - Check `alembic/versions/` for the newly created migration
   - Review the generated SQL to ensure it matches your expectations

4. **Apply the migration**:
   ```bash
   alembic upgrade head
   ```

## Common Commands

### Create a new migration
```bash
alembic revision --autogenerate -m "Description of changes"
```

### Apply migrations
```bash
alembic upgrade head
```

### Rollback one migration
```bash
alembic downgrade -1
```

### Rollback to a specific revision
```bash
alembic downgrade <revision_id>
```

### View current database revision
```bash
alembic current
```

### View migration history
```bash
alembic history
```

## Troubleshooting

### Migration conflicts
If you have conflicts, you may need to:
1. Review the conflicting migration
2. Manually edit the migration file
3. Or reset and recreate (development only!)

### Database connection issues
- Verify `DATABASE_URL` in `.env` is correct
- Check that your database is accessible
- For Supabase: Ensure your IP is whitelisted (or use connection pooling)

### Models not detected
- Ensure all models are imported in `app/models/__init__.py`
- Check that `alembic/env.py` imports all models

## Production Considerations

- Always review autogenerated migrations before applying
- Test migrations on a staging database first
- Use `alembic upgrade head` in your deployment pipeline
- Never edit existing migration files that have been applied to production


